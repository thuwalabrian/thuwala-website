{% extends "base.html" %}

{% block title %}Reset Password - Admin{% endblock %}

{% block content %}
<div class="admin-login-container">
    <div class="login-wrapper">
        <div class="login-right-panel">
            <div class="login-box">
                <div class="login-header">
                    <h2>Reset Your Password</h2>
                    <p>Create a new password for your account</p>
                </div>
                
                <!-- Flash Messages -->
                <div class="flash-messages">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="flash flash-{{ category }} animate__animated animate__fadeIn">
                                    <div class="flash-content">
                                        <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                                        <span>{{ message }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                </div>
                
                <form method="POST" action="{{ url_for('reset_password', token=token) }}" class="login-form" id="resetForm">
                    <div class="form-group">
                        <label for="password" class="form-label">
                            <i class="fas fa-key"></i> New Password
                        </label>
                        <input type="password" 
                               id="password" 
                               name="password" 
                               required 
                               class="form-control"
                               placeholder="Enter new password"
                               autocomplete="new-password"
                               minlength="8">
                        <div class="password-strength" id="passwordStrength">
                            <div class="strength-bar"></div>
                            <div class="strength-label">Password strength</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm_password" class="form-label">
                            <i class="fas fa-key"></i> Confirm Password
                        </label>
                        <input type="password" 
                               id="confirm_password" 
                               name="confirm_password" 
                               required 
                               class="form-control"
                               placeholder="Confirm new password"
                               autocomplete="new-password"
                               minlength="8">
                        <div class="password-match" id="passwordMatch">
                            <i class="fas fa-check-circle" style="display: none;"></i>
                            <span>Passwords must match</span>
                        </div>
                    </div>
                    
                    <div class="password-requirements">
                        <h4><i class="fas fa-shield-alt"></i> Password Requirements:</h4>
                        <ul>
                            <li id="req-length">At least 8 characters long</li>
                            <li id="req-upper">Contains uppercase letter</li>
                            <li id="req-lower">Contains lowercase letter</li>
                            <li id="req-number">Contains number</li>
                            <li id="req-special">Contains special character</li>
                        </ul>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-login" id="resetButton" disabled>
                            <span class="btn-text">Reset Password</span>
                        </button>
                        <a href="{{ url_for('admin_login') }}" class="btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Login
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.password-match {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: var(--gray);
}

.password-match i {
    color: #10b981;
}

.password-requirements {
    margin: 1.5rem 0;
    padding: 1.5rem;
    background: var(--light);
    border-radius: var(--radius);
}

.password-requirements h4 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 0 0 1rem;
    color: var(--dark);
    font-size: 1rem;
}

.password-requirements ul {
    margin: 0;
    padding-left: 1.5rem;
    color: var(--gray);
}

.password-requirements li {
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    position: relative;
    transition: color 0.3s;
}

.password-requirements li.valid {
    color: #10b981;
}

.password-requirements li.valid::before {
    content: '✓ ';
    color: #10b981;
    font-weight: bold;
}

.password-requirements li.invalid {
    color: #ef4444;
}

.password-requirements li.invalid::before {
    content: '✗ ';
    color: #ef4444;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm_password');
    const strengthBar = document.querySelector('.strength-bar');
    const strengthLabel = document.querySelector('.strength-label');
    const passwordMatch = document.getElementById('passwordMatch');
    const matchIcon = passwordMatch.querySelector('i');
    const matchText = passwordMatch.querySelector('span');
    const resetButton = document.getElementById('resetButton');
    const resetForm = document.getElementById('resetForm');
    
    // Password requirement elements
    const reqLength = document.getElementById('req-length');
    const reqUpper = document.getElementById('req-upper');
    const reqLower = document.getElementById('req-lower');
    const reqNumber = document.getElementById('req-number');
    const reqSpecial = document.getElementById('req-special');
    
    function checkPasswordStrength(password) {
        let strength = 0;
        
        // Length check
        if (password.length >= 8) {
            strength += 20;
            reqLength.classList.remove('invalid');
            reqLength.classList.add('valid');
        } else {
            reqLength.classList.remove('valid');
            reqLength.classList.add('invalid');
        }
        
        // Upper case check
        if (/[A-Z]/.test(password)) {
            strength += 20;
            reqUpper.classList.remove('invalid');
            reqUpper.classList.add('valid');
        } else {
            reqUpper.classList.remove('valid');
            reqUpper.classList.add('invalid');
        }
        
        // Lower case check
        if (/[a-z]/.test(password)) {
            strength += 20;
            reqLower.classList.remove('invalid');
            reqLower.classList.add('valid');
        } else {
            reqLower.classList.remove('valid');
            reqLower.classList.add('invalid');
        }
        
        // Number check
        if (/[0-9]/.test(password)) {
            strength += 20;
            reqNumber.classList.remove('invalid');
            reqNumber.classList.add('valid');
        } else {
            reqNumber.classList.remove('valid');
            reqNumber.classList.add('invalid');
        }
        
        // Special character check
        if (/[^A-Za-z0-9]/.test(password)) {
            strength += 20;
            reqSpecial.classList.remove('invalid');
            reqSpecial.classList.add('valid');
        } else {
            reqSpecial.classList.remove('valid');
            reqSpecial.classList.add('invalid');
        }
        
        // Update strength bar
        strengthBar.style.setProperty('--strength-width', strength + '%');
        
        // Update label
        if (password.length === 0) {
            strengthLabel.textContent = 'Password strength';
            strengthLabel.style.color = 'var(--gray)';
        } else if (strength < 40) {
            strengthLabel.textContent = 'Weak';
            strengthLabel.style.color = '#ef4444';
        } else if (strength < 70) {
            strengthLabel.textContent = 'Fair';
            strengthLabel.style.color = '#f59e0b';
        } else if (strength < 90) {
            strengthLabel.textContent = 'Good';
            strengthLabel.style.color = '#10b981';
        } else {
            strengthLabel.textContent = 'Strong';
            strengthLabel.style.color = '#059669';
        }
        
        return strength;
    }
    
    function checkPasswordMatch() {
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        
        if (confirm.length === 0) {
            matchIcon.style.display = 'none';
            matchText.textContent = 'Passwords must match';
            matchText.style.color = 'var(--gray)';
            return false;
        }
        
        if (password === confirm) {
            matchIcon.style.display = 'inline-block';
            matchText.textContent = 'Passwords match';
            matchText.style.color = '#10b981';
            return true;
        } else {
            matchIcon.style.display = 'none';
            matchText.textContent = 'Passwords do not match';
            matchText.style.color = '#ef4444';
            return false;
        }
    }
    
    function validateForm() {
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        
        const strength = checkPasswordStrength(password);
        const match = checkPasswordMatch();
        
        // Enable button only if password is strong enough and matches
        if (strength >= 60 && match && password.length >= 8) {
            resetButton.disabled = false;
        } else {
            resetButton.disabled = true;
        }
    }
    
    // Event listeners
    passwordInput.addEventListener('input', validateForm);
    confirmInput.addEventListener('input', validateForm);
    
    // Add CSS variable for strength bar width
    document.documentElement.style.setProperty('--strength-width', '0%');
    
    // Initial validation
    validateForm();
});
</script>
{% endblock %}